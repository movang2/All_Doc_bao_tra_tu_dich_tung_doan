<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>H·ªçc v√† Tra T·ª´ V·ª±ng H√†n - Vi·ªát</title>
<style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        textarea {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-word, .delete-article {
            background-color: #ff4444;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 14px;
        }
        .delete-word:hover, .delete-article:hover {
            background-color: #cc0000;
        }
        .output {
            margin-top: 20px;
            white-space: pre-line;
            text-align: left;
        }
        .pair {
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            display: flex;
            align-items: flex-start;
        }
        .pair.highlight {
            background: #d4edda;
            border: 2px solid #4CAF50;
        }
        .speaker-icon {
            margin-right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #4CAF50;
        }
        .speaker-icon:hover {
            color: #45a049;
        }
        .hidden {
            display: none;
        }
        .kr {
            color: blue;
            font-weight: bold;
        }
        .vi {
            color: green;
            font-weight: bold;
        }
        .word {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .word:hover {
            background-color: #f0f0f0;
            text-decoration: underline;
        }
        #lookupList {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 100px;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left;
            margin-top: 20px;
        }
        .lookup-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .lookup-item span {
            margin-right: 10px;
        }
        .lookup-item input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
        }
        .slider-container input[type="range"] {
            width: 80%;
        }
        .slider-value {
            font-size: 14px;
            color: #666;
        }
        #articleList {
            margin-top: 30px;
            text-align: left;
        }
        .article-item {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            background: #f0f8ff;
            border-left: 4px solid #4CAF50;
            cursor: pointer;
            border-radius: 4px;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .article-item:hover {
            background: #e0f0ff;
        }
        .active-article {
            background: #d4edda;
        }
    </style>
</head>
<body>
<!-- Ph·∫ßn 1: X·ª≠ l√Ω vƒÉn b·∫£n song ng·ªØ & TTS -->
<div class="section">

<!-- Th√™m ph·∫ßn d·ªãch t·ª´ng ƒëo·∫°n -->
<div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px;">
<h3>D·ªãch T·ª´ng ƒêo·∫°n</h3>
<label for="lang">M√£ ng√¥n ng·ªØ ngu·ªìn (v√≠ d·ª•: ko, en, ja...):</label>
<input id="lang" style="width: 80px; margin-bottom:10px;" value="ko"/><br/>
<label for="delay">Th·ªùi gian ch·ªù gi·ªØa m·ªói ƒëo·∫°n (ms):</label>
<input id="delay" style="width: 100px;" type="number" value="1000"/><br/>
<textarea id="inputText" placeholder="Nh·∫≠p ho·∫∑c d√°n vƒÉn b·∫£n t·∫°i ƒë√¢y..." style="width: 80%; height: 100px;"></textarea>
<br/>
<button onclick="startTranslation()">D·ªãch t·ª´ng ƒëo·∫°n</button>
<button onclick="pauseTranslation()">‚è∏Ô∏è T·∫°m d·ª´ng</button>
<button onclick="resumeTranslation()">‚ñ∂Ô∏è Ti·∫øp t·ª•c</button>
<button onclick="saveTranslationAsTxt()">üíæ L∆∞u TXT</button>
<div id="translationResult" style="margin-top: 15px;"></div>
</div>
<h2>X·ª≠ l√Ω VƒÉn B·∫£n Song Ng·ªØ &amp; TTS</h2>
<label for="articleTitle">Ti√™u ƒë·ªÅ b√†i b√°o:</label><br/>
<input id="articleTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ (t√πy ch·ªçn)" style="width: 80%; padding: 10px; margin-bottom: 10px;" type="text"/><br/>
<label for="koreanText">Ti·∫øng H√†n:</label><br/>
<textarea id="koreanText" placeholder="Nh·∫≠p vƒÉn b·∫£n ti·∫øng H√†n..."></textarea><br/>
<label for="vietnameseText">Ti·∫øng Vi·ªát:</label><br/>
<textarea id="vietnameseText" placeholder="Nh·∫≠p b·∫£n d·ªãch ti·∫øng Vi·ªát..."></textarea><br/>
<div class="slider-container">
<label for="speechRate">T·ªëc ƒë·ªô n√≥i (0.1 - 2): <span class="slider-value" id="speechRateValue">1</span></label>
<input id="speechRate" max="2" min="0.1" oninput="updateSliderValue('speechRate', 'speechRateValue')" step="0.1" type="range" value="1"/>
</div>
<div class="slider-container">
<label for="pauseTime">Th·ªùi gian ngh·ªâ (ms): <span class="slider-value" id="pauseTimeValue">1000</span></label>
<input id="pauseTime" max="5000" min="0" oninput="updateSliderValue('pauseTime', 'pauseTimeValue')" step="100" type="range" value="1000"/>
</div>
<button onclick="processText()">T·∫°o VƒÉn B·∫£n Song Ng·ªØ</button>
<button id="speakButton" onclick="speakText()">üîä ƒê·ªçc VƒÉn B·∫£n</button>
<button class="hidden" id="pauseButton" onclick="pauseText()">‚è∏ T·∫°m d·ª´ng</button>
<button class="hidden" id="resumeButton" onclick="resumeText()">‚ñ∂ Ti·∫øp t·ª•c</button>
<button onclick="saveCurrentArticle()">üíæ L∆∞u b√†i b√°o</button>
<button onclick="exportVocabulary()">üì§ Xu·∫•t t·ª´ v·ª±ng</button>
<div class="output" id="output"></div>
<h3>Danh s√°ch t·ª´ ƒë√£ tra</h3>
<div id="lookupList"></div>
</div>
<!-- Ph·∫ßn danh s√°ch b√†i b√°o -->
<div class="section">
<h2>Danh s√°ch b√†i b√°o</h2>
<div id="articleList"></div>
</div>
<!-- Ph·∫ßn l∆∞u v√† kh√¥i ph·ª•c -->
<div class="section">
<h2>L∆∞u v√† Kh√¥i ph·ª•c</h2>
<button onclick="saveState()">üíæ L∆∞u tr·∫°ng th√°i</button>
<input accept=".json" id="loadFile" onchange="loadState(event)" type="file"/>
<label for="loadFile">Ch·ªçn file ƒë·ªÉ kh√¥i ph·ª•c</label>
</div>
<script>
        // --- Bi·∫øn to√†n c·ª•c ---
        let lookedUpWords = new Map();
        let articles = JSON.parse(localStorage.getItem('koreanArticles')) || [];
        let currentArticleId = null;
        let isSpeaking = false;
        let isPaused = false;
        let currentUtterance = null;
        let currentIndex = 0;
        let elements = [];

        // --- Kh·ªüi t·∫°o ---
        document.addEventListener('DOMContentLoaded', function() {
            renderArticleList();
        });

        // --- Ch·ª©c nƒÉng 1: X·ª≠ l√Ω vƒÉn b·∫£n song ng·ªØ & TTS ---
        function processText() {
            let koreanLines = document.getElementById("koreanText").value.trim().split("\n");
            let vietnameseLines = document.getElementById("vietnameseText").value.trim().split("\n");
            let outputDiv = document.getElementById("output");
            outputDiv.innerHTML = "";

            let maxLines = Math.max(koreanLines.length, vietnameseLines.length);

            for (let i = 0; i < maxLines; i++) {
                let kr = koreanLines[i] ? koreanLines[i].trim() : "";
                let vi = vietnameseLines[i] ? vietnameseLines[i].trim() : "";
                
                let pairDiv = document.createElement("div");
                pairDiv.className = "pair";
                pairDiv.dataset.index = i;
                
                // Th√™m bi·ªÉu t∆∞·ª£ng loa
                let speakerIcon = document.createElement("span");
                speakerIcon.className = "speaker-icon";
                speakerIcon.innerText = "üîä";
                speakerIcon.onclick = () => startFromPair(i); // S·ª± ki·ªán TTS cho bi·ªÉu t∆∞·ª£ng loa
                pairDiv.appendChild(speakerIcon);

                // Container cho n·ªôi dung c√¢u
                let contentDiv = document.createElement("div");
                contentDiv.className = "pair-content";

                if (kr) {
                    let krSpan = document.createElement("span");
                    krSpan.className = "kr";
                    krSpan.innerHTML = kr.split(/(\s+)/).map(part => {
                        if (part.trim() === "") return part;
                        return `<span class="word" onclick="lookupWord(event, '${encodeURIComponent(part)}')">${part}</span>`;
                    }).join("");
                    contentDiv.appendChild(krSpan);
                    contentDiv.appendChild(document.createElement("br"));
                }
                
                if (vi) {
                    let viSpan = document.createElement("span");
                    viSpan.className = "vi";
                    viSpan.innerText = vi;
                    contentDiv.appendChild(viSpan);
                }

                pairDiv.appendChild(contentDiv);
                outputDiv.appendChild(pairDiv);
            }
        }

        function speakText() {
            startFromPair(0); // B·∫Øt ƒë·∫ßu t·ª´ ƒë·∫ßu khi nh·∫•n n√∫t "ƒê·ªçc VƒÉn B·∫£n"
        }

        function startFromPair(index) {
            if (isSpeaking) {
                stopSpeaking(); // D·ª´ng ph√°t √¢m hi·ªán t·∫°i n·∫øu ƒëang ph√°t
            }
            isSpeaking = true;
            isPaused = false;
            currentIndex = index; // B·∫Øt ƒë·∫ßu t·ª´ ch·ªâ s·ªë ƒë∆∞·ª£c ch·ªçn
            elements = document.getElementById("output").getElementsByClassName("pair");
            document.getElementById("speakButton").classList.add("hidden");
            document.getElementById("pauseButton").classList.remove("hidden");
            document.getElementById("resumeButton").classList.add("hidden");
            speechSynthesis.cancel(); // H·ªßy c√°c utterance c≈©
            speakNext(currentIndex);
        }

        function speakNext(index) {
            if (index >= elements.length || !isSpeaking) {
                stopSpeaking();
                return;
            }

            // X√≥a highlight c≈©
            document.querySelectorAll('.pair').forEach(pair => pair.classList.remove('highlight'));
            // Highlight c√¢u hi·ªán t·∫°i
            elements[index].classList.add('highlight');

            let krText = elements[index].getElementsByClassName("kr")[0]?.innerText || "";
            let viText = elements[index].getElementsByClassName("vi")[0]?.innerText || "";
            const speechRate = parseFloat(document.getElementById("speechRate").value);
            const pauseTime = parseInt(document.getElementById("pauseTime").value);

            function speak(text, lang, callback) {
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = lang;
                currentUtterance.rate = speechRate;
                currentUtterance.onend = callback;
                speechSynthesis.speak(currentUtterance);
            }

            if (krText) {
                speak(krText, "ko-KR", () => {
                    if (isPaused || !isSpeaking) return;
                    if (viText) {
                        setTimeout(() => {
                            speak(viText, "vi-VN", () => speakNext(index + 1));
                        }, pauseTime);
                    } else {
                        speakNext(index + 1);
                    }
                });
            } else if (viText) {
                speak(viText, "vi-VN", () => speakNext(index + 1));
            } else {
                speakNext(index + 1);
            }
        }

        function pauseText() {
            if (isSpeaking && !isPaused) {
                isPaused = true;
                speechSynthesis.pause();
                document.getElementById("pauseButton").classList.add("hidden");
                document.getElementById("resumeButton").classList.remove("hidden");
            }
        }

        function resumeText() {
            if (isSpeaking && isPaused) {
                isPaused = false;
                speechSynthesis.resume();
                document.getElementById("pauseButton").classList.remove("hidden");
                document.getElementById("resumeButton").classList.add("hidden");
            }
        }

        function stopSpeaking() {
            isSpeaking = false;
            isPaused = false;
            currentUtterance = null;
            currentIndex = 0;
            speechSynthesis.cancel();
            document.getElementById("speakButton").classList.remove("hidden");
            document.getElementById("pauseButton").classList.add("hidden");
            document.getElementById("resumeButton").classList.add("hidden");
            document.querySelectorAll('.pair').forEach(pair => pair.classList.remove('highlight'));
        }

        // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã c·ªßa thanh tr∆∞·ª£t
        function updateSliderValue(sliderId, valueId) {
            document.getElementById(valueId).textContent = document.getElementById(sliderId).value;
        }

        // --- Ch·ª©c nƒÉng tra t·ª´ ƒëi·ªÉn ---
        function lookupWord(event, word) {
            event.stopPropagation(); // NgƒÉn s·ª± ki·ªán nh·∫•p chu·ªôt lan truy·ªÅn
            const decodedWord = decodeURIComponent(word);
            const url = `https://korean.dict.naver.com/kovidict/#/search?query=${word}`;
            window.open(url, '_blank');
            if (!lookedUpWords.has(decodedWord)) {
                lookedUpWords.set(decodedWord, "");
            }
            updateLookupList();
        }

        function updateLookupList() {
            const lookupList = document.getElementById('lookupList');
            lookupList.innerHTML = Array.from(lookedUpWords.entries())
                .map(([word, meaning]) => `
                    <div class="lookup-item">
                        <span>${word}</span>
                        <input type="text" value="${meaning}" placeholder="Ghi nghƒ©a..." oninput="updateMeaning('${word}', this.value)">
                        <button class="delete-word" onclick="deleteWord('${encodeURIComponent(word)}')">X√≥a</button>
                    </div>
                `).join('');
        }

        function updateMeaning(word, meaning) {
            lookedUpWords.set(word, meaning);
        }

        function deleteWord(encodedWord) {
            const word = decodeURIComponent(encodedWord);
            lookedUpWords.delete(word);
            updateLookupList();
        }

        // --- Ch·ª©c nƒÉng xu·∫•t t·ª´ v·ª±ng ---
        function exportVocabulary() {
            const choice = prompt("Nh·∫≠p 'current' ƒë·ªÉ xu·∫•t t·ª´ v·ª±ng c·ªßa b√†i b√°o hi·ªán t·∫°i, ho·∫∑c 'all' ƒë·ªÉ xu·∫•t to√†n b·ªô t·ª´ v·ª±ng:");
            if (!choice) return;

            let wordsToExport = [];
            if (choice.toLowerCase() === 'current' && currentArticleId) {
                const article = articles.find(a => a.id === currentArticleId);
                if (article && article.words) {
                    wordsToExport = article.words;
                }
            } else if (choice.toLowerCase() === 'all') {
                const allWords = new Map();
                articles.forEach(article => {
                    if (article.words) {
                        article.words.forEach(([word, meaning]) => {
                            if (!allWords.has(word)) {
                                allWords.set(word, meaning);
                            }
                        });
                    }
                });
                wordsToExport = Array.from(allWords.entries());
            } else {
                alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p "current" ho·∫∑c "all".');
                return;
            }

            if (wordsToExport.length === 0) {
                alert('Kh√¥ng c√≥ t·ª´ v·ª±ng ƒë·ªÉ xu·∫•t!');
                return;
            }

            // Xu·∫•t d∆∞·ªõi d·∫°ng CSV
            let csvContent = "T·ª´ v·ª±ng,Nghƒ©a\n";
            wordsToExport.forEach(([word, meaning]) => {
                csvContent += `"${word.replace(/"/g, '""')}","${meaning.replace(/"/g, '""')}"\n`;
            });

            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-');
            const fileName = `vocabulary_${timestamp}.csv`;

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- Ch·ª©c nƒÉng qu·∫£n l√Ω b√†i b√°o ---
        function saveCurrentArticle() {
            const title = document.getElementById('articleTitle').value.trim() || `B√†i b√°o ${articles.length + 1}`;
            const koreanText = document.getElementById('koreanText').value;
            const vietnameseText = document.getElementById('vietnameseText').value;
            const speechRate = document.getElementById('speechRate').value;
            const pauseTime = document.getElementById('pauseTime').value;
            
            if (!koreanText || !vietnameseText) {
                alert('Vui l√≤ng nh·∫≠p c·∫£ vƒÉn b·∫£n ti·∫øng H√†n v√† b·∫£n d·ªãch ti·∫øng Vi·ªát!');
                return;
            }

            const article = {
                id: Date.now().toString(),
                title: title,
                displayNumber: articles.length + 1,
                koreanText: koreanText,
                vietnameseText: vietnameseText,
                speechRate: speechRate,
                pauseTime: pauseTime,
                words: Array.from(lookedUpWords.entries()),
                createdAt: new Date().toISOString()
            };

            articles.push(article);
            currentArticleId = article.id;
            saveArticlesToLocalStorage();
            renderArticleList();
            loadArticle(article.id);
            alert('ƒê√£ l∆∞u b√†i b√°o!');
        }

        function deleteArticle(articleId) {
            articles = articles.filter(a => a.id !== articleId);
            // C·∫≠p nh·∫≠t l·∫°i displayNumber
            articles.forEach((article, index) => {
                article.displayNumber = index + 1;
            });
            saveArticlesToLocalStorage();
            renderArticleList();
            if (articleId === currentArticleId) {
                currentArticleId = null;
                document.getElementById('articleTitle').value = '';
                document.getElementById('koreanText').value = '';
                document.getElementById('vietnameseText').value = '';
                document.getElementById('speechRate').value = 1;
                document.getElementById('pauseTime').value = 1000;
                updateSliderValue('speechRate', 'speechRateValue');
                updateSliderValue('pauseTime', 'pauseTimeValue');
                document.getElementById('output').innerHTML = '';
                lookedUpWords = new Map();
                updateLookupList();
            }
        }

        function loadArticle(articleId) {
            const article = articles.find(a => a.id === articleId);
            if (!article) return;

            currentArticleId = articleId;
            document.getElementById('articleTitle').value = article.title;
            document.getElementById('koreanText').value = article.koreanText;
            document.getElementById('vietnameseText').value = article.vietnameseText;
            document.getElementById('speechRate').value = article.speechRate;
            document.getElementById('pauseTime').value = article.pauseTime;
            updateSliderValue('speechRate', 'speechRateValue');
            updateSliderValue('pauseTime', 'pauseTimeValue');

            // C·∫≠p nh·∫≠t t·ª´ ƒë√£ tra
            lookedUpWords = new Map(article.words || []);
            updateLookupList();

            // X·ª≠ l√Ω hi·ªÉn th·ªã vƒÉn b·∫£n song ng·ªØ
            processText();

            // C·∫≠p nh·∫≠t giao di·ªán danh s√°ch b√†i b√°o
            document.querySelectorAll('.article-item').forEach(item => {
                item.classList.remove('active-article');
                if (item.dataset.id === articleId) {
                    item.classList.add('active-article');
                }
            });
        }

        function renderArticleList() {
            const articleListContainer = document.getElementById('articleList');
            if (articles.length === 0) {
                articleListContainer.innerHTML = '<p>Ch∆∞a c√≥ b√†i b√°o n√†o ƒë∆∞·ª£c l∆∞u</p>';
                return;
            }

            articleListContainer.innerHTML = articles.map(article => `
                <div class="article-item ${article.id === currentArticleId ? 'active-article' : ''}" 
                     data-id="${article.id}">
                    <span onclick="loadArticle('${article.id}')">${article.title}</span>
                    <button class="delete-article" onclick="deleteArticle('${article.id}')">X√≥a</button>
                </div>
            `).join('');
        }

        function saveArticlesToLocalStorage() {
            try {
                localStorage.setItem('koreanArticles', JSON.stringify(articles));
            } catch (e) {
                console.error('L·ªói khi l∆∞u v√†o localStorage:', e);
                alert('Kh√¥ng th·ªÉ l∆∞u b√†i b√°o v√†o localStorage. Vui l√≤ng ki·ªÉm tra dung l∆∞·ª£ng ho·∫∑c quy·ªÅn truy c·∫≠p.');
            }
        }

        // --- Ch·ª©c nƒÉng l∆∞u v√† kh√¥i ph·ª•c ---
        function saveState() {
            const state = {
                articles: articles,
                currentArticleId: currentArticleId,
                lookedUpWords: Array.from(lookedUpWords.entries())
            };
            
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-');
            const fileName = `korean_study_${timestamp}.json`;

            const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadState(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const state = JSON.parse(e.target.result);
                    
                    // Kh√¥i ph·ª•c b√†i b√°o
                    if (state.articles) {
                        articles = state.articles;
                        // C·∫≠p nh·∫≠t displayNumber cho c√°c b√†i b√°o
                        articles.forEach((article, index) => {
                            article.displayNumber = index + 1;
                        });
                        saveArticlesToLocalStorage();
                    }
                    
                    // Kh√¥i ph·ª•c t·ª´ ƒë√£ tra
                    if (state.lookedUpWords) {
                        lookedUpWords = new Map(state.lookedUpWords);
                        updateLookupList();
                    }
                    
                    // Kh√¥i ph·ª•c b√†i b√°o ƒëang xem
                    if (state.currentArticleId) {
                        currentArticleId = state.currentArticleId;
                        loadArticle(currentArticleId);
                    }
                    
                    renderArticleList();
                    alert('ƒê√£ kh√¥i ph·ª•c tr·∫°ng th√°i th√†nh c√¥ng!');
                } catch (e) {
                    console.error('L·ªói khi kh√¥i ph·ª•c tr·∫°ng th√°i:', e);
                    alert('Kh√¥ng th·ªÉ kh√¥i ph·ª•c tr·∫°ng th√°i. Vui l√≤ng ki·ªÉm tra file JSON.');
                }
            };
            reader.readAsText(file);
        }
    
// --- Bi·∫øn to√†n c·ª•c cho ph·∫ßn d·ªãch ---
let translationPause = false;
let translationLines = [];
let translationIndex = 0;

// --- Ch·ª©c nƒÉng d·ªãch t·ª´ng ƒëo·∫°n ---
async function fetchTranslate(text, sl, tl = 'vi') {
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=` + encodeURIComponent(text);
    try {
        const res = await fetch(url);
        const data = await res.json();
        return data[0].map(x => x[0]).join('');
    } catch (error) {
        console.error('L·ªói khi d·ªãch:', error);
        return "L·ªói khi d·ªãch: " + error.message;
    }
}

async function startTranslation() {
    translationPause = false;
    const text = document.getElementById('inputText').value.trim();
    const lang = document.getElementById('lang').value || 'ko';
    const delay = parseInt(document.getElementById('delay').value || 1000);
    translationLines = text.split(/\n+/).filter(x => x.trim());
    translationIndex = 0;
    document.getElementById('translationResult').innerHTML = '';

    while (translationIndex < translationLines.length) {
        if (translationPause) break;
        const original = translationLines[translationIndex];
        const translated = await fetchTranslate(original, lang);

        const div = document.createElement('div');
        div.className = 'block';
        div.style.marginBottom = '15px';
        div.style.paddingBottom = '10px';
        div.style.borderBottom = '1px dashed #ccc';
        div.innerHTML = `
            <div style="font-weight: bold; color: #333;">‚ñ∂ ${original}</div>
<div style="color: #006400; margin-top: 5px;">‚ñ∂ ${translated}</div>
        `;

        document.getElementById('translationResult').appendChild(div);
        translationIndex++;

        document.getElementById('koreanText').value += (document.getElementById('koreanText').value ? '\n' : '') + original;
        document.getElementById('vietnameseText').value += (document.getElementById('vietnameseText').value ? '\n' : '') + translated;

        await new Promise(r => setTimeout(r, delay));
    }
}

function pauseTranslation() {
    translationPause = true;
}

function resumeTranslation() {
    translationPause = false;
    startTranslation();
}

function saveTranslationAsTxt() {
    let content = "";
    document.querySelectorAll("#translationResult .block").forEach(div => {
        const ori = div.querySelector('div:first-child')?.innerText.replace('‚ñ∂ ', '') || '';
        const tra = div.querySelector('div:last-child')?.innerText.replace('‚ñ∂ ', '') || '';
        content += ori + "\n" + tra + "\n\n";
    });

    if (!content.trim()) {
        alert('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ l∆∞u!');
        return;
    }

    const blob = new Blob([content], {type: "text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ban_dich_song_ngu.txt";
    a.click();
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>